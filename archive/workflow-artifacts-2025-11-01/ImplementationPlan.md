# Implementation Plan: Safe Selective Installation System

## Executive Summary

**Goal**: Create manifest-driven installation and update system that preserves user data while safely updating Agentic Substrate components.

**Key Decision**: Use explicit manifest system (not discovery-based) combined with version tracking to ensure we ONLY touch our 35 managed files and NEVER interfere with Claude CLI's 11+ protected directories and user data.

**Risk Level**: HIGH (data loss potential if implemented incorrectly)
**Estimated Complexity**: MEDIUM
**Estimated Time**: 90-120 minutes (implementation + testing)

---

## 1. Implementation Strategy

### Core Principles

**Explicit over Implicit**:
- Manifest lists every managed file explicitly
- No `cp -r` or glob patterns
- File-by-file copying with verification

**Safety First**:
- Full backup before any changes
- Atomic operations (all-or-nothing)
- Rollback script generated before changes applied
- Validation at every step

**Data Preservation**:
- NEVER touch CLI-managed files (history.jsonl, debug/, projects/, etc.)
- NEVER touch user settings (settings.json, settings.local.json)
- NEVER touch runtime state (.circuit-breaker-state)
- Preserve user modifications with conflict detection

**Version Tracking**:
- Simple version file: `~/.claude/.agentic-substrate-version`
- Comprehensive manifest: `~/.claude/.agentic-substrate-manifest.json`
- Enable intelligent updates (only changed files)

### Architecture

```
Repository                    Installation System              User's ~/.claude/
-----------                   -------------------              ------------------
.claude/
‚îú‚îÄ‚îÄ agents/           ‚îÄ‚îÄ‚îÄ‚îê
‚îú‚îÄ‚îÄ skills/           ‚îÄ‚îÄ‚îÄ‚î§
‚îú‚îÄ‚îÄ commands/         ‚îÄ‚îÄ‚îÄ‚î§
‚îú‚îÄ‚îÄ hooks/            ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> install.sh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ~/.claude/
‚îú‚îÄ‚îÄ validators/       ‚îÄ‚îÄ‚îÄ‚î§    (manifest-driven)                (selective copy)
‚îú‚îÄ‚îÄ metrics/          ‚îÄ‚îÄ‚îÄ‚î§
‚îî‚îÄ‚îÄ templates/        ‚îÄ‚îÄ‚îÄ‚îò    update.sh                        .agentic-substrate-version
                              (change detection)               .agentic-substrate-manifest.json
manifest-template.json                                         rollback-to-vX.Y.Z.sh
(source of truth)             .gitignore
                              (exclude user data)
```

---

## 2. Files to Create/Modify

### New Files (5)

**1. `.gitignore`** (root directory)
- **Purpose**: Exclude user-specific files from git
- **Size**: ~15 lines
- **Priority**: HIGH (prevents accidental commits)

**2. `manifest-template.json`** (root directory)
- **Purpose**: Source of truth for managed files
- **Size**: ~200 lines (all 35 files + metadata)
- **Priority**: CRITICAL (core of new system)

**3. `update.sh`** (root directory)
- **Purpose**: Intelligent update script
- **Size**: ~250 lines
- **Priority**: HIGH (replaces update-local-installation.sh)

**4. `validate-install.sh`** (root directory)
- **Purpose**: Test installation integrity
- **Size**: ~150 lines
- **Priority**: MEDIUM (testing aid)

**5. `uninstall.sh`** (root directory)
- **Purpose**: Clean removal with data preservation
- **Size**: ~100 lines
- **Priority**: LOW (nice to have)

### Modified Files (2)

**1. `install.sh`**
- **Changes**: Complete rewrite (200+ lines changed)
- **Why**: Replace `cp -r` with manifest-driven selective copy
- **Risk**: HIGH (main installation script)

**2. `manifest.json`**
- **Changes**: Restructure for installation tracking
- **Why**: Add file list, version metadata, protected paths
- **Risk**: LOW (metadata file)

### Deprecated Files (1)

**1. `update-local-installation.sh`**
- **Action**: Archive to `/archive/` directory
- **Why**: Replaced by generic `update.sh`
- **Risk**: NONE (can be restored if needed)

### Files to Remove from Repository (4)

**In `.claude/` directory**:
1. `.circuit-breaker-state` - Runtime state (regenerated by tools)
2. `.DS_Store` - macOS metadata (system-generated)
3. `settings.json` - User preferences (should not be in repo)
4. `settings.local.json` - User overrides (should not be in repo)

---

## 3. Step-by-Step Implementation

### Prerequisites
- [ ] Full backup of current repository: `git commit -am "Pre-installation-fix checkpoint"`
- [ ] Test environment ready (can test on actual ~/.claude/)
- [ ] Bash 4+ available on macOS

### Step 1: Create .gitignore (5 min)

**File**: `/Users/amba/Code/claude-user-memory/.gitignore`

**Content**:
```gitignore
# macOS metadata
.DS_Store
*.DS_Store

# User-specific files (should not be in repo)
.claude/settings.json
.claude/settings.local.json
.claude/.circuit-breaker-state

# IDE files
.vscode/
.idea/

# Backup directories created during testing
.claude.backup-*/

# Test artifacts
test-results/
```

**Verification**:
```bash
git status
# Should show .gitignore as new file
# Should NOT show .claude/settings.json, .claude/.circuit-breaker-state, etc.
```

**Time**: 5 min

---

### Step 2: Remove User-Specific Files from Git (10 min)

**Task**: Remove tracked files that shouldn't be in repository

**Commands**:
```bash
# Remove from git but keep in working directory
git rm --cached .claude/settings.json
git rm --cached .claude/settings.local.json
git rm --cached .claude/.circuit-breaker-state
git rm --cached .claude/.DS_Store

# Verify they're removed from git but still in filesystem
git status
ls -la .claude/

# Commit removal
git commit -m "fix: Remove user-specific files from repository tracking

These files are user/runtime-specific and should not be in the repo:
- settings.json, settings.local.json (user preferences)
- .circuit-breaker-state (runtime state)
- .DS_Store (macOS metadata)

Added to .gitignore to prevent future commits."
```

**Verification**:
```bash
# Files should exist in filesystem but not in git
ls .claude/settings.json  # Should exist
git ls-files | grep settings.json  # Should be empty
```

**Time**: 10 min

---

### Step 3: Create Manifest Template (20 min)

**File**: `/Users/amba/Code/claude-user-memory/manifest-template.json`

**Structure**:
```json
{
  "manifest_version": "1.0.0",
  "substrate_version": "3.1.0",
  "managed_files": [
    "agents/brahma-analyzer.md",
    "agents/brahma-deployer.md",
    "agents/brahma-investigator.md",
    "agents/brahma-monitor.md",
    "agents/brahma-optimizer.md",
    "agents/chief-architect.md",
    "agents/code-implementer.md",
    "agents/docs-researcher.md",
    "agents/implementation-planner.md",
    "skills/context-engineering/skill.md",
    "skills/pattern-recognition/skill.md",
    "skills/planning-methodology/skill.md",
    "skills/quality-validation/skill.md",
    "skills/research-methodology/skill.md",
    "commands/context.md",
    "commands/implement.md",
    "commands/plan.md",
    "commands/research.md",
    "commands/workflow.md",
    "hooks/auto-format.sh",
    "hooks/check-agent-economics.sh",
    "hooks/run-tests.sh",
    "hooks/suggest-context-edits.sh",
    "hooks/update-knowledge-core.sh",
    "hooks/validate-implementation-plan.sh",
    "hooks/validate-research-pack.sh",
    "validators/api-matcher.sh",
    "validators/circuit-breaker.sh",
    "metrics/tracker.sh",
    "templates/agentic-substrate-personal.md.example",
    "templates/agents-overview.md",
    "templates/CLAUDE.md.template",
    "templates/CLAUDE.md.user-level",
    "templates/skills-overview.md",
    "templates/workflows-overview.md"
  ],
  "executable_files": [
    "hooks/auto-format.sh",
    "hooks/check-agent-economics.sh",
    "hooks/run-tests.sh",
    "hooks/suggest-context-edits.sh",
    "hooks/update-knowledge-core.sh",
    "hooks/validate-implementation-plan.sh",
    "hooks/validate-research-pack.sh",
    "validators/api-matcher.sh",
    "validators/circuit-breaker.sh",
    "metrics/tracker.sh"
  ],
  "protected_paths": [
    "debug/",
    "file-history/",
    "history.jsonl",
    "projects/",
    "session-env/",
    "settings.json",
    "settings.local.json",
    "shell-snapshots/",
    "statsig/",
    "todos/",
    "plugins/",
    "ide/",
    ".circuit-breaker-state",
    ".DS_Store"
  ],
  "special_handling": {
    "pattern-index.json": {
      "action": "preserve",
      "reason": "User-generated pattern learning data"
    },
    "CLAUDE.md": {
      "action": "install-from-template",
      "source": "templates/CLAUDE.md.user-level",
      "reason": "User-level configuration file"
    }
  },
  "metadata": {
    "total_files": 35,
    "agents": 9,
    "skills": 5,
    "commands": 5,
    "hooks": 7,
    "validators": 2,
    "metrics": 1,
    "templates": 6
  }
}
```

**Verification**:
```bash
# Validate JSON syntax
cat manifest-template.json | python3 -m json.tool > /dev/null
echo $?  # Should be 0

# Count managed files
jq '.managed_files | length' manifest-template.json
# Should output: 35
```

**Time**: 20 min

---

### Step 4: Rewrite install.sh (40 min)

**File**: `/Users/amba/Code/claude-user-memory/install.sh`

**Key Changes**:
1. Replace `cp -r` with manifest-driven file-by-file copy
2. Add version detection (check existing installation)
3. Add conflict detection (user modifications)
4. Generate manifest in `~/.claude/.agentic-substrate-manifest.json`
5. Write version to `~/.claude/.agentic-substrate-version`
6. Generate rollback script
7. Add dry-run mode (`--dry-run` flag)

**New Structure**:
```bash
#!/usr/bin/env bash
# Agentic Substrate v3.1 - Safe Selective Installation
# Manifest-driven installation with data preservation

set -e

VERSION="3.1.0"

# Parse flags
DRY_RUN=false
FORCE=false
while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run) DRY_RUN=true; shift ;;
    --force) FORCE=true; shift ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

# Functions
function log_info() { echo "‚ÑπÔ∏è  $1"; }
function log_success() { echo "‚úÖ $1"; }
function log_warning() { echo "‚ö†Ô∏è  $1"; }
function log_error() { echo "‚ùå $1"; }

# 1. Pre-flight checks
function preflight_checks() {
  # Check source directory
  # Check manifest-template.json exists
  # Check write permissions
  # Detect existing installation
}

# 2. Create backup
function create_backup() {
  # Full backup to ~/.claude.backup-TIMESTAMP
  # Only if ~/.claude exists
}

# 3. Install files
function install_files() {
  # Read manifest-template.json
  # Create directory structure
  # Copy files one by one (not cp -r)
  # Set executable permissions
  # Special handling for CLAUDE.md
  # Preserve pattern-index.json if exists
}

# 4. Generate manifest
function generate_manifest() {
  # Create ~/.claude/.agentic-substrate-manifest.json
  # Include installation timestamp
  # Calculate checksums for each file
}

# 5. Write version
function write_version() {
  # Create ~/.claude/.agentic-substrate-version
  # Contains: 3.1.0
}

# 6. Generate rollback script
function generate_rollback() {
  # Create ~/.claude/rollback-to-vX.Y.Z.sh
  # Executable script that restores backup
}

# 7. Validate installation
function validate_installation() {
  # Check all 35 files present
  # Check permissions on .sh files
  # Check version file
  # Check manifest
}

# 8. Display summary
function display_summary() {
  # Show what was installed
  # Show what was preserved
  # Show next steps
}

# Main execution
main() {
  log_info "Agentic Substrate v$VERSION - Safe Selective Installation"

  if [ "$DRY_RUN" = true ]; then
    log_info "DRY RUN MODE - No changes will be made"
  fi

  preflight_checks
  create_backup
  install_files
  generate_manifest
  write_version
  generate_rollback
  validate_installation
  display_summary
}

main
```

**Verification**:
```bash
# Dry run (no changes)
./install.sh --dry-run

# Real installation
./install.sh

# Check installation
ls -la ~/.claude/.agentic-substrate-version
cat ~/.claude/.agentic-substrate-version  # Should show: 3.1.0

ls -la ~/.claude/.agentic-substrate-manifest.json
jq '.substrate_version' ~/.claude/.agentic-substrate-manifest.json  # Should show: "3.1.0"
```

**Time**: 40 min

---

### Step 5: Create update.sh (35 min)

**File**: `/Users/amba/Code/claude-user-memory/update.sh`

**Key Features**:
1. Detect current version from `~/.claude/.agentic-substrate-version`
2. Compare with new version
3. Read current manifest
4. Detect changed files (checksum comparison)
5. Detect user modifications
6. Prompt for confirmation
7. Selective update (only changed files)
8. Update manifest and version
9. Generate rollback script

**Structure**:
```bash
#!/usr/bin/env bash
# Agentic Substrate - Intelligent Update Script
# Selectively updates only changed files, preserves user data

set -e

NEW_VERSION="3.1.0"

# Functions
function detect_current_version() {
  # Read ~/.claude/.agentic-substrate-version
  # Return version or "none"
}

function detect_changes() {
  # Compare manifest-template.json with installed manifest
  # Calculate checksums
  # Build list of changed files
}

function detect_user_modifications() {
  # Compare installed files with checksums in manifest
  # Identify user-modified files
}

function prompt_user() {
  # Show what will be updated
  # Show user modifications that will be overwritten
  # Ask for confirmation
}

function backup_changed_files() {
  # Create incremental backup
  # Only backup files being updated
}

function update_files() {
  # Copy only changed files
  # Set permissions
  # Update manifest
  # Update version
}

function generate_rollback() {
  # Create rollback script
}

function validate_update() {
  # Run tests
  # Verify all files present
}

main() {
  CURRENT=$(detect_current_version)

  if [ "$CURRENT" = "none" ]; then
    log_error "No installation detected. Run install.sh first."
    exit 1
  fi

  if [ "$CURRENT" = "$NEW_VERSION" ]; then
    log_info "Already at version $NEW_VERSION"
    exit 0
  fi

  log_info "Updating from v$CURRENT to v$NEW_VERSION"

  detect_changes
  detect_user_modifications
  prompt_user
  backup_changed_files
  update_files
  generate_rollback
  validate_update

  log_success "Update complete!"
}

main "$@"
```

**Verification**:
```bash
# Update from existing installation
./update.sh

# Should show:
# - Current version detected
# - Files to be updated
# - User modifications (if any)
# - Confirmation prompt
# - Update progress
# - Success message
```

**Time**: 35 min

---

### Step 6: Create validate-install.sh (15 min)

**File**: `/Users/amba/Code/claude-user-memory/validate-install.sh`

**Purpose**: Automated testing of installation integrity

**Tests**:
```bash
#!/usr/bin/env bash
# Validation script for installation testing

ERRORS=0

function test_version_file() {
  if [ ! -f ~/.claude/.agentic-substrate-version ]; then
    echo "‚ùå Version file missing"
    ((ERRORS++))
  else
    VERSION=$(cat ~/.claude/.agentic-substrate-version)
    if [ "$VERSION" != "3.1.0" ]; then
      echo "‚ùå Incorrect version: $VERSION"
      ((ERRORS++))
    else
      echo "‚úÖ Version file correct"
    fi
  fi
}

function test_manifest() {
  if [ ! -f ~/.claude/.agentic-substrate-manifest.json ]; then
    echo "‚ùå Manifest missing"
    ((ERRORS++))
  else
    COUNT=$(jq '.managed_files | length' ~/.claude/.agentic-substrate-manifest.json)
    if [ "$COUNT" -ne 35 ]; then
      echo "‚ùå Manifest incomplete: $COUNT files (expected 35)"
      ((ERRORS++))
    else
      echo "‚úÖ Manifest complete"
    fi
  fi
}

function test_all_files_present() {
  # Check all 35 files exist
  while IFS= read -r file; do
    if [ ! -f "$HOME/.claude/$file" ]; then
      echo "‚ùå Missing file: $file"
      ((ERRORS++))
    fi
  done < <(jq -r '.managed_files[]' ~/.claude/.agentic-substrate-manifest.json)

  if [ $ERRORS -eq 0 ]; then
    echo "‚úÖ All managed files present"
  fi
}

function test_permissions() {
  # Check .sh files are executable
  local COUNT=0
  for file in ~/.claude/hooks/*.sh ~/.claude/validators/*.sh ~/.claude/metrics/*.sh; do
    if [ ! -x "$file" ]; then
      echo "‚ùå Not executable: $file"
      ((ERRORS++))
    fi
    ((COUNT++))
  done

  if [ $COUNT -eq 10 ]; then
    echo "‚úÖ All scripts executable"
  fi
}

function test_protected_files_untouched() {
  # Verify we didn't touch CLI files
  # (Can only test if they existed before)
  if [ -f ~/.claude/history.jsonl ]; then
    echo "‚úÖ history.jsonl preserved"
  fi
}

# Run all tests
echo "üß™ Validating installation..."
test_version_file
test_manifest
test_all_files_present
test_permissions
test_protected_files_untouched

if [ $ERRORS -eq 0 ]; then
  echo ""
  echo "‚úÖ All validation tests passed!"
  exit 0
else
  echo ""
  echo "‚ùå $ERRORS validation test(s) failed"
  exit 1
fi
```

**Verification**:
```bash
chmod +x validate-install.sh
./validate-install.sh

# Should output:
# ‚úÖ Version file correct
# ‚úÖ Manifest complete
# ‚úÖ All managed files present
# ‚úÖ All scripts executable
# ‚úÖ history.jsonl preserved
# ‚úÖ All validation tests passed!
```

**Time**: 15 min

---

### Step 7: Archive Old Update Script (2 min)

**Task**: Move deprecated script to archive

**Commands**:
```bash
mkdir -p archive
git mv update-local-installation.sh archive/update-local-installation-v3.1.sh
git commit -m "chore: Archive v3.1-specific update script

Replaced by generic update.sh that works for any version update.
Preserved for reference in archive/ directory."
```

**Time**: 2 min

---

### Step 8: Update manifest.json Version (3 min)

**File**: `/Users/amba/Code/claude-user-memory/manifest.json`

**Changes**:
```json
{
  "dxt_version": "1.0.0",
  "name": "agentic-substrate",
  "version": "3.1.0",  // Update from 3.0.0
  // ... rest unchanged
}
```

**Commands**:
```bash
# Update version field
sed -i.bak 's/"version": "3.0.0"/"version": "3.1.0"/' manifest.json
rm manifest.json.bak

git diff manifest.json  # Verify only version changed
```

**Time**: 3 min

---

## 4. Risk Assessment & Mitigations

### Risk 1: Data Loss During Installation
**Probability**: MEDIUM
**Impact**: CRITICAL
**Scenario**: Overwriting user files, deleting user data

**Mitigation**:
- Full backup before any changes (`~/.claude.backup-TIMESTAMP`)
- Manifest-driven copying (explicit file list, no glob patterns)
- Protected paths list (never touch CLI directories)
- Dry-run mode for testing
- Rollback script generated before changes

**Detection**:
- User reports missing files
- history.jsonl missing/corrupted
- Custom agents deleted

**Contingency**:
```bash
# Immediate rollback
mv ~/.claude ~/.claude-failed-install
mv ~/.claude.backup-20251101-120000 ~/.claude
```

---

### Risk 2: Partial Installation Failure
**Probability**: LOW
**Impact**: HIGH
**Scenario**: Installation interrupted mid-process

**Mitigation**:
- Atomic operations (bash `set -e` exits on error)
- Backup created before any changes
- Rollback script available
- Validation after installation

**Detection**:
- Error during install.sh execution
- Validation tests fail
- Files missing

**Contingency**:
```bash
# Automatic rollback on error (built into install.sh)
# Or manual:
~/.claude/rollback-to-v3.0.sh
```

---

### Risk 3: Version Conflict
**Probability**: LOW
**Impact**: MEDIUM
**Scenario**: Installing older version over newer version

**Mitigation**:
- Version detection before install
- Warning if downgrading
- Confirmation prompt before proceeding
- Backup always created

**Detection**:
- install.sh checks `.agentic-substrate-version`
- Compares with version being installed
- Warns if downgrade detected

**Contingency**:
- User can abort installation
- User can force with `--force` flag
- Backup available for rollback

---

### Risk 4: User Modifications Lost
**Probability**: MEDIUM
**Impact**: MEDIUM
**Scenario**: User customized our files, update overwrites them

**Mitigation**:
- Checksum comparison detects modifications
- update.sh shows which files were modified
- Prompts user before overwriting
- Backup of modified files
- Option to skip specific files

**Detection**:
- update.sh compares installed file checksums with manifest
- Identifies modified files

**Contingency**:
```bash
# User can:
# 1. Abort update, manually merge changes
# 2. Proceed with update, restore from backup
# 3. Selectively update (skip modified files)
```

---

### Risk 5: Manifest Corruption
**Probability**: LOW
**Impact**: MEDIUM
**Scenario**: Manifest JSON becomes invalid

**Mitigation**:
- JSON validation before use
- manifest-template.json in repo (can regenerate)
- Backup includes manifest

**Detection**:
```bash
jq '.' ~/.claude/.agentic-substrate-manifest.json
# If error: invalid JSON
```

**Contingency**:
```bash
# Regenerate from template
cp manifest-template.json ~/.claude/.agentic-substrate-manifest.json
```

---

## 5. Rollback Procedure

### Automatic Rollback (Built into Scripts)

**install.sh** generates rollback script at `~/.claude/rollback-to-vX.Y.Z.sh`:

```bash
#!/usr/bin/env bash
# Auto-generated rollback script for Agentic Substrate
# Created: 2025-11-01 22:00:00
# Rollback from: v3.1.0
# Rollback to: v3.0.0
# Backup location: ~/.claude.backup-20251101-220000

echo "üîÑ Rolling back Agentic Substrate..."
echo "   From: v3.1.0"
echo "   To: v3.0.0"
echo ""

# Confirm
read -p "Proceed with rollback? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Rollback cancelled"
    exit 1
fi

# Backup current state
ROLLBACK_BACKUP="$HOME/.claude.rollback-backup-$(date +%Y%m%d-%H%M%S)"
echo "üì¶ Backing up current state to $ROLLBACK_BACKUP"
cp -r "$HOME/.claude" "$ROLLBACK_BACKUP"

# Restore from backup
BACKUP_DIR="$HOME/.claude.backup-20251101-220000"
if [ ! -d "$BACKUP_DIR" ]; then
    echo "‚ùå Backup directory not found: $BACKUP_DIR"
    exit 1
fi

echo "‚ôªÔ∏è  Restoring from backup..."
rm -rf "$HOME/.claude"
cp -r "$BACKUP_DIR" "$HOME/.claude"

echo "‚úÖ Rollback complete!"
echo ""
echo "Your installation has been restored to v3.0.0"
echo "Current state backed up to: $ROLLBACK_BACKUP"
```

**Usage**:
```bash
~/.claude/rollback-to-v3.0.sh
```

---

### Manual Rollback (If Script Unavailable)

**Step 1: Identify backup**
```bash
ls -lt ~/*.backup-* | head -1
# Shows most recent backup
```

**Step 2: Restore**
```bash
BACKUP="$HOME/.claude.backup-20251101-220000"  # Use your backup name
mv ~/.claude ~/.claude-failed
mv "$BACKUP" ~/.claude
```

**Step 3: Verify**
```bash
cat ~/.claude/.agentic-substrate-version
# Should show previous version

./validate-install.sh
# Should pass all tests
```

---

### Partial Rollback (Selective File Restore)

**If only certain files are problematic**:

```bash
BACKUP="$HOME/.claude.backup-20251101-220000"

# Restore specific file
cp "$BACKUP/agents/chief-architect.md" ~/.claude/agents/

# Restore entire directory
cp -r "$BACKUP/hooks/" ~/.claude/

# Verify
./validate-install.sh
```

---

## 6. Verification Steps

### After Install (install.sh)

**Test 1: Version Tracking**
```bash
# Version file exists and correct
cat ~/.claude/.agentic-substrate-version
# Expected output: 3.1.0

# Manifest exists and valid
jq '.substrate_version' ~/.claude/.agentic-substrate-manifest.json
# Expected output: "3.1.0"
```

**Test 2: All Files Present**
```bash
# Run validation script
./validate-install.sh
# Expected output: ‚úÖ All validation tests passed!

# Manual check
jq -r '.managed_files[]' ~/.claude/.agentic-substrate-manifest.json | while read file; do
  if [ ! -f "$HOME/.claude/$file" ]; then
    echo "MISSING: $file"
  fi
done
# Expected output: (nothing - all files present)
```

**Test 3: Permissions Correct**
```bash
# All .sh files executable
find ~/.claude/hooks ~/.claude/validators ~/.claude/metrics -name "*.sh" ! -executable
# Expected output: (nothing - all are executable)
```

**Test 4: Protected Files Untouched**
```bash
# If you had history.jsonl before install
ls -lh ~/.claude/history.jsonl
# Should have same timestamp and size as before

# If you had custom files
ls ~/.claude/agents/my-custom-agent.md
# Should still exist
```

**Test 5: Rollback Script Generated**
```bash
ls -la ~/.claude/rollback-to-v*.sh
# Should exist and be executable

# Test dry-run
cat ~/.claude/rollback-to-v3.0.sh
# Should show backup location
```

---

### After Update (update.sh)

**Test 1: Version Updated**
```bash
cat ~/.claude/.agentic-substrate-version
# Should show new version: 3.1.0
```

**Test 2: Only Changed Files Updated**
```bash
# Compare timestamps
ls -lt ~/.claude/agents/
# Recently updated files should have new timestamp
# Unchanged files should have old timestamp
```

**Test 3: User Data Preserved**
```bash
# pattern-index.json preserved (if existed)
ls -la ~/.claude/pattern-index.json

# Custom files preserved
ls ~/.claude/agents/my-custom-agent.md
```

**Test 4: Manifest Updated**
```bash
jq '.substrate_version' ~/.claude/.agentic-substrate-manifest.json
# Should show: "3.1.0"

jq '.installed_at' ~/.claude/.agentic-substrate-manifest.json
# Should show current timestamp
```

---

### Full Integration Test

**Scenario 1: Fresh Install**
```bash
# Clean slate
rm -rf ~/.claude

# Install
./install.sh

# Validate
./validate-install.sh
# Expected: ‚úÖ All tests pass

# Verify Claude CLI still works
# (Cannot automate - requires user to test)
```

**Scenario 2: Upgrade from v3.0**
```bash
# Simulate v3.0 installation
# (Would need old install.sh)

# Upgrade
./update.sh

# Validate
./validate-install.sh
# Expected: ‚úÖ All tests pass
```

**Scenario 3: Reinstall Same Version**
```bash
# Already at v3.1.0
./install.sh

# Should detect existing version
# Expected output: "Already installed. Use update.sh or --force"
```

**Scenario 4: Rollback**
```bash
# After install
./install.sh

# Rollback
~/.claude/rollback-to-v3.0.sh

# Validate
cat ~/.claude/.agentic-substrate-version
# Expected: 3.0.0 (or whatever was previous)
```

**Scenario 5: User Modifications Preserved**
```bash
# Modify a file
echo "# My custom note" >> ~/.claude/agents/chief-architect.md

# Update
./update.sh

# Should detect modification
# Expected output: "‚ö†Ô∏è  Modified files detected: agents/chief-architect.md"

# User can choose to preserve or overwrite
```

---

## 7. Success Criteria

Implementation is complete when:

**Installation**:
- ‚úÖ install.sh uses manifest-driven copying (no `cp -r`)
- ‚úÖ install.sh detects existing installation
- ‚úÖ install.sh creates version file
- ‚úÖ install.sh generates manifest
- ‚úÖ install.sh generates rollback script
- ‚úÖ install.sh validates installation
- ‚úÖ All 35 managed files installed correctly
- ‚úÖ Permissions set on all .sh files
- ‚úÖ Protected files never touched

**Updates**:
- ‚úÖ update.sh detects current version
- ‚úÖ update.sh identifies changed files
- ‚úÖ update.sh detects user modifications
- ‚úÖ update.sh updates only changed files
- ‚úÖ update.sh preserves user data
- ‚úÖ update.sh updates manifest and version

**Safety**:
- ‚úÖ Full backup created before changes
- ‚úÖ Rollback script functional
- ‚úÖ Validation tests pass
- ‚úÖ No data loss in any scenario
- ‚úÖ User modifications preserved or warned

**Repository Hygiene**:
- ‚úÖ User-specific files removed from git
- ‚úÖ .gitignore prevents future commits
- ‚úÖ manifest-template.json is source of truth
- ‚úÖ Documentation updated

**Quality Checklist**:
- [ ] Code matches ResearchPack requirements exactly
- [ ] Error handling implemented (set -e, validation)
- [ ] Edge cases covered in tests
- [ ] No hardcoded values (version from variable)
- [ ] Logging added for debugging
- [ ] Security concerns addressed (no eval, safe paths)

---

## 8. Timeline Estimate

### Implementation Phase (90 min)

| Step | Task | Time | Cumulative |
|------|------|------|------------|
| 1 | Create .gitignore | 5 min | 5 min |
| 2 | Remove user files from git | 10 min | 15 min |
| 3 | Create manifest-template.json | 20 min | 35 min |
| 4 | Rewrite install.sh | 40 min | 75 min |
| 5 | Create update.sh | 35 min | 110 min |
| 6 | Create validate-install.sh | 15 min | 125 min |
| 7 | Archive old update script | 2 min | 127 min |
| 8 | Update manifest.json version | 3 min | 130 min |

**Total Implementation**: ~130 minutes (2h 10min)

### Testing Phase (30 min)

| Test | Time |
|------|------|
| Fresh install test | 5 min |
| Update test | 5 min |
| Rollback test | 5 min |
| User modification test | 5 min |
| Validation script test | 5 min |
| Documentation review | 5 min |

**Total Testing**: ~30 minutes

### Total Project Time: ~160 minutes (2h 40min)

**Buffer for Issues**: +30 min
**Conservative Estimate**: 3 hours

---

## 9. Rollback Plan (Implementation-Level)

**If implementation gets stuck**:

### Checkpoint 1: After .gitignore (Step 1-2)
**Rollback**:
```bash
git checkout .gitignore
git reset HEAD .claude/settings.json .claude/settings.local.json
git checkout .claude/settings.json .claude/settings.local.json
```

### Checkpoint 2: After manifest-template.json (Step 3)
**Rollback**:
```bash
git checkout manifest-template.json
# Plus Checkpoint 1 if needed
```

### Checkpoint 3: After install.sh rewrite (Step 4)
**Rollback**:
```bash
git checkout install.sh
# Plus previous checkpoints if needed
```

### Complete Rollback (All Changes)
```bash
git reset --hard HEAD
# Or restore from pre-implementation commit:
git reset --hard [commit-hash]
```

---

## 10. Open Questions for User

**Before Implementation**:

1. **Settings files in repo**:
   - Remove `.claude/settings.json` and `.claude/settings.local.json` from repository?
   - **Recommendation**: YES - these should not be tracked

2. **Data/scripts directories**:
   - Are `data/` and `scripts/` needed? (referenced in update-local but don't exist in repo)
   - **Recommendation**: Remove references if not used

3. **User modification handling**:
   - Should update.sh prompt before overwriting user-modified files?
   - Or auto-backup and replace?
   - **Recommendation**: Prompt with options (keep, overwrite, diff)

4. **Partial updates**:
   - Support selective updates (e.g., update only agents, skip skills)?
   - **Recommendation**: Future enhancement (v3.2)

5. **Dry-run testing**:
   - Test on actual `~/.claude/` or create test directory?
   - **Recommendation**: Use actual directory with backup

---

## 11. References

**ResearchPack**: `/Users/amba/Code/claude-user-memory/ResearchPack.md`

**Knowledge Core**: N/A (pattern will be captured after implementation)

**Codebase Patterns Observed**:
- Naming: Bash scripts use kebab-case, .sh extension
- Structure: Modular functions with main() entry point
- Testing: Validation scripts in repository root
- Logging: Emoji prefixes for visual clarity

**Anthropic Best Practices**:
- Minimal changes (surgical edits)
- Reversibility (rollback always available)
- Verification (validate at each step)
- Safety first (backup before changes)

---

## 12. Plan Metadata

- **Created**: 2025-11-01 22:15:00
- **Based on**: ResearchPack for Installation System Improvement
- **Agent**: implementation-planner v3.1
- **Estimated Complexity**: MEDIUM
- **Risk Level**: HIGH (data preservation critical)
- **Think Protocol**: ultrathink used for architecture decisions

---

‚úÖ **Plan ready for @code-implementer or manual implementation**

**Next Steps**:
1. Review plan with user
2. Confirm open questions
3. Begin implementation at Step 1
4. Test thoroughly before committing
5. Update documentation after success
